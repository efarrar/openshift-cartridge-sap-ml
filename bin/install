#!/bin/bash -e

source $OPENSHIFT_CARTRIDGE_SDK_BASH

mkdir -p $OPENSHIFT_ML_DIR/versions/16.0/mysql-connector-odbc/
wget -P $OPENSHIFT_TMP_DIR http://downloads.mysql.com/archives/get/file/mysql-connector-odbc-5.1.6-linux-glibc2.3-x86-64bit.tar.gz
tar -xf $OPENSHIFT_TMP_DIR/mysql-connector-odbc-5.1.6-linux-glibc2.3-x86-64bit.tar.gz -C "${OPENSHIFT_ML_DIR}/versions/16.0/mysql-connector-odbc"

mkdir -p $OPENSHIFT_ML_DIR/versions/16.0/mobilink/
wget -P $OPENSHIFT_TMP_DIR https://s3-us-west-2.amazonaws.com/efarrar-ml-testing-temp/openshift-mobilink.tar.gz
tar -xf $OPENSHIFT_TMP_DIR/openshift-mobilink.tar.gz -C "${OPENSHIFT_ML_DIR}/versions/16.0/mobilink"

ln -s $OPENSHIFT_ML_DIR/versions/16.0/mobilink/libodbcinst.so $OPENSHIFT_ML_DIR/versions/16.0/mobilink/libodbcinst.so.1

ML_DB_NAME=mobilink
ML_USERNAME=$(generate_username)
ML_PASSWORD=$(generate_password)

env_dir="${OPENSHIFT_ML_DIR}/env"
set_env_var 'ML_DB_NAME' ${ML_DB_NAME} $env_dir
set_env_var 'ML_USERNAME' ${ML_USERNAME} $env_dir
set_env_var 'ML_PASSWORD' ${ML_PASSWORD} $env_dir

mysql -u $OPENSHIFT_MYSQL_DB_USERNAME --password=$OPENSHIFT_MYSQL_DB_PASSWORD -h $OPENSHIFT_MYSQL_DB_HOST -P $OPENSHIFT_MYSQL_DB_PORT -D $OPENSHIFT_APP_NAME -e "CREATE SCHEMA mobilink; GRANT ALL ON mobilink.* to '${ML_USERNAME}'@'%' IDENTIFIED BY '${ML_PASSWORD}'; GRANT ALL ON ${OPENSHIFT_APP_NAME}.* TO '${ML_USERNAME}'@'%'"

mysql -u $ML_USERNAME --password=$ML_PASSWORD -h $OPENSHIFT_MYSQL_DB_HOST -P $OPENSHIFT_MYSQL_DB_PORT -D mobilink < $OPENSHIFT_ML_DIR/versions/16.0/mobilink/syncmys.sql
